<!DOCTYPE html>
<html>
  <head>
    <title>Start Player</title>
    <meta name="viewport" content="user-scalable=no">
    <style type="text/css">
      body { margin: 0px; overflow: hidden; }
      canvas {
        position: absolute;
        top: 0px;
        z-index: 10;
      }
      #players {
        position: absolute;
        top: 0px;
        width: 100%;
      }
    </style>
    <script type="text/javascript" src="hammer.min.js"></script>
    <script type="text/javascript">

    var canvas;
    var ctx;
    var w = 0;
    var h = 0;

    var touches = [];

    var radius = 125;

    var state = "start";
    var sleepTime;
    var iterations;
    var index = 0;

    var startNumPlayers = 4;
    var numPlayers = 4;
    var settingsTouchStart;

    function drawCircle(px, py, color) {
      ctx.beginPath();
      ctx.arc(px, py, radius, 0, 2*Math.PI, true);

      ctx.fillStyle = color + ", 0.2)";//"rgba(0, 0, 200, 0.2)";
      ctx.fill();

      ctx.lineWidth = 2.0;
      ctx.strokeStyle = color + ", 0.8)";
      ctx.stroke();
    }

    function update() {
      try {
        ctx.clearRect(0, 0, w, h);

        if (state == "pick") {
          var touch = touches[index];
          var px = touch.pageX;
          var py = touch.pageY;
          if (iterations <= 0) {
            drawCircle(px, py, "rgba(200, 0, 0");
          } else {
            drawCircle(px, py, "rgba(0, 0, 200");
          }

        } else {
          for (var i=0; i < touches.length; i++) {
            var touch = touches[i];
            var px = touch.pageX;
            var py = touch.pageY;
            drawCircle(px, py, "rgba(0, 0, 200");
          }
        }

        window.requestAnimationFrame(update);
      } catch (e) {
        alert(e);
      }
    }

    function iterateTouches() {
      try {
        index = (index + 1) % touches.length;
        sleepTime += Math.random()*150/(iterations+1);
        iterations--;

        if (iterations > 0) {
          setTimeout(iterateTouches, sleepTime);
        } else {
          setTimeout(function() {
            state = "start";
            touches = [];
          }, 3000);
        }
      } catch (e) {
        alert(e);
      }
    }

    function main() {
      canvas = document.getElementById('canvas');

      w = window.innerWidth;
      h = window.innerHeight;

      canvas.style.width = w+'px';
      canvas.style.height = h+'px';
      canvas.width = w;
      canvas.height = h;

      players = document.getElementById('players');
      players.style.fontSize = h/2 + 'px';
      players.innerHTML = numPlayers;

      ctx = canvas.getContext('2d');

      window.requestAnimationFrame(update);

      canvas.addEventListener('touchend', function() {
        if (state == "start") {
          touches = event.touches;
        }
      });

      canvas.addEventListener('touchmove', function(event) {
        try {
          event.preventDefault();
          if (state == "start") {
            touches = event.touches;

            if (touches.length == 1) {
              numPlayers = startNumPlayers - parseInt((event.targetTouches[0].pageY - settingsTouchStart)/50);
              if (numPlayers < 2) {
                numPlayers = 2;
              }
              players.innerHTML = numPlayers;
            }
          }
        } catch (e) {
          alert(e);
        }
      });

      canvas.addEventListener('touchstart', function(event) {
        try {
          if (state == "start") {
            touches = event.touches;

            if (touches.length == 1) {
              settingsTouchStart = event.targetTouches[0].pageY;
              startNumPlayers = numPlayers;
            } else if (touches.length == numPlayers) {
              state = "pick";
              iterations = 30 + Math.random() * touches.length*2;
              sleepTime = 0;
              iterateTouches();
            }
          }
        } catch (e) {
          alert(e);
        }
      });
    };

    </script>
  </head>
  <body onload="main()">
    
    <canvas id="canvas"></canvas>
    <center id="players"></center>
  </body>
</html>